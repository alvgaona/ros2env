name: Release
run-name: release ${{ github.ref_name }}

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  publish-crate:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      - uses: Swatinem/rust-cache@v2
      - run: cargo fmt --check
      - run: cargo clippy --all-features -- -D warnings
      - run: cargo test --all-features
      - run: cargo publish --all-features || echo "Crate already published"
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  build-binaries:
    name: Build Binaries
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            use_cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            use_cross: true
          - os: macos-latest
            target: aarch64-apple-darwin
            use_cross: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Install cross
        if: matrix.use_cross
        run: cargo install cross --git https://github.com/cross-rs/cross
      - name: Build
        run: |
          if [ "${{ matrix.use_cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
      - name: Strip binary
        if: ${{ !matrix.use_cross }}
        run: strip target/${{ matrix.target }}/release/rosenv
      - name: Create tarball
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../rosenv-${{ matrix.target }}-${{ github.ref_name }}.tar.gz rosenv
      - uses: actions/upload-artifact@v4
        with:
          name: rosenv-${{ matrix.target }}
          path: rosenv-${{ matrix.target }}-${{ github.ref_name }}.tar.gz

  build-and-publish-conda:
    name: Build & Publish Conda Package
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-64
          - os: ubuntu-latest
            platform: linux-aarch64
          - os: macos-latest
            platform: osx-arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Set version from tag
        run: echo "ROSENV_VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV
      - uses: prefix-dev/rattler-build-action@v0.2.22
        with:
          recipe-path: recipe/recipe.yaml
          upload-artifact: true
          artifact-name: rosenv-conda-${{ matrix.platform }}
          build-args: --target-platform ${{ matrix.platform }} --package-format tar-bz2
      - name: Upload to prefix.dev
        run: |
          for pkg in $(find output -type f \( -name "*.conda" -o -name "*.tar.bz2" \)); do
            rattler-build upload prefix -c ${{ vars.PREFIX_DEV_CHANNEL }} "$pkg"
          done
        env:
          PREFIX_API_KEY: ${{ secrets.PREFIX_API_KEY }}

  release:
    name: Create Release
    needs: [publish-crate, build-binaries, build-and-publish-conda]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: orhun/git-cliff-action@v4
        id: changelog
        with:
          args: --latest
      - name: Generate release notes
        run: echo "${{ steps.changelog.outputs.content }}" | tail -n +2 > RELEASE_NOTES.md
      - name: Download linux artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: rosenv-*-linux-*
          path: artifacts
          merge-multiple: true
      - name: Download macos artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: rosenv-*-darwin
          path: artifacts
          merge-multiple: true
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          body_path: RELEASE_NOTES.md
          files: artifacts/*
